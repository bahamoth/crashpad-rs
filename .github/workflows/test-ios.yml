name: Build iOS

on:
  pull_request:

permissions:
  pull-requests: write

concurrency:
  group: ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ios:
    if: github.actor != 'release-please[bot]'
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 'stable'
      - uses: Swatinem/rust-cache@v2
      - name: Install dependencies
        run: |
          cargo xtask install-tools
      - name: Add iOS targets
        run: |
          rustup target add aarch64-apple-ios
          rustup target add aarch64-apple-ios-sim
          rustup target add x86_64-apple-ios
      - name: iOS Build (aarch64)
        run: |
          cargo build -p crashpad-rs-sys --target aarch64-apple-ios
          cargo build -p crashpad-rs --target aarch64-apple-ios
      
      # iOS Simulator tests
      - name: Build for iOS Simulator
        run: |
          cargo build -p crashpad-rs-sys --target aarch64-apple-ios-sim
          cargo build -p crashpad-rs --target aarch64-apple-ios-sim
          cargo build --example ios_simulator_test --target aarch64-apple-ios-sim --release

      - name: Setup iOS Simulator
        run: |
          # List available runtimes and devices for debugging
          echo "Available iOS runtimes:"
          xcrun simctl list runtimes
          echo "Available devices:"
          xcrun simctl list devices available
          
          # Use the first available iPhone simulator
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}')
          
          if [ -z "$SIMULATOR_ID" ]; then
            echo "No iPhone simulator found, creating one..."
            # Try to create with available runtime
            RUNTIME=$(xcrun simctl list runtimes | grep iOS | tail -1 | grep -oE 'com.apple.CoreSimulator.SimRuntime.iOS-[0-9-]+')
            xcrun simctl create "TestiPhone" "iPhone 14" "$RUNTIME" || \
            xcrun simctl create "TestiPhone" "com.apple.CoreSimulator.SimDeviceType.iPhone-14" "$RUNTIME"
            SIMULATOR_ID=$(xcrun simctl list devices | grep "TestiPhone" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}')
          fi
          
          echo "Using simulator: $SIMULATOR_ID"
          echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV
          
          # Boot the simulator
          xcrun simctl boot "$SIMULATOR_ID" || echo "Simulator already booted"
          
          # Wait for boot to complete
          xcrun simctl bootstatus "$SIMULATOR_ID" -b || echo "Boot status check failed, continuing..."

      - name: Run iOS Simulator Tests
        run: |
          # Copy test binary to simulator
          TEST_BIN="./target/aarch64-apple-ios-sim/release/examples/ios_simulator_test"
          
          # Test 1: Normal initialization
          echo "=== Test 1: Initialization test ==="
          INIT_OUTPUT=$(xcrun simctl spawn "$SIMULATOR_ID" "$TEST_BIN" 2>&1 || {
            echo "Direct spawn failed, trying with upload..."
            # Upload the binary to simulator's tmp directory
            xcrun simctl upload "$SIMULATOR_ID" "$TEST_BIN" /tmp/ios_simulator_test
            xcrun simctl spawn "$SIMULATOR_ID" /tmp/ios_simulator_test 2>&1
          })
          echo "$INIT_OUTPUT"
          
          if echo "$INIT_OUTPUT" | grep -q "âœ“ Started in-process handler"; then
            echo "âœ… PASS: Handler initialized successfully"
            echo "test1_result=PASS" >> test_results.env
          else
            echo "âŒ FAIL: Handler initialization failed"
            echo "test1_result=FAIL" >> test_results.env
            exit 1
          fi
          
          # Test 2: Crash test (expected to crash)
          echo -e "\n=== Test 2: Crash test ==="
          CRASH_OUTPUT=$(xcrun simctl spawn "$SIMULATOR_ID" "$TEST_BIN" crash 2>&1 || true)
          echo "$CRASH_OUTPUT"
          
          if echo "$CRASH_OUTPUT" | grep -q "Triggering crash now"; then
            echo "âœ… PASS: Crash triggered as expected"
            echo "test2_result=PASS" >> test_results.env
          else
            echo "âŒ FAIL: Crash trigger failed"
            echo "test2_result=FAIL" >> test_results.env
          fi
          
          # Give time for crash processing
          sleep 2
          
          # Test 3: TAP mode test
          echo -e "\n=== Test 3: TAP mode test ==="
          TAP_OUTPUT=$(xcrun simctl spawn "$SIMULATOR_ID" "$TEST_BIN" test 2>&1 || true)
          echo "$TAP_OUTPUT"
          
          if echo "$TAP_OUTPUT" | grep -q "# All tests passed"; then
            echo "âœ… PASS: TAP tests passed"
            echo "test3_result=PASS" >> test_results.env
          else
            echo "âŒ FAIL: TAP tests failed"
            echo "test3_result=FAIL" >> test_results.env
          fi
          
          # Summary
          echo -e "\n=== Test Summary ==="
          source test_results.env 2>/dev/null || true
          echo "Test 1 (Initialization): ${test1_result:-UNKNOWN}"
          echo "Test 2 (Crash Trigger): ${test2_result:-UNKNOWN}"
          echo "Test 3 (TAP Mode): ${test3_result:-UNKNOWN}"
          
          # Note: iOS in-process handler stores dumps differently than desktop platforms
          # Dumps are typically processed on next app launch
          
          # Exit with failure if any test failed
          if [ "${test1_result}" = "FAIL" ] || [ "${test3_result}" = "FAIL" ]; then
            exit 1
          fi

      - name: Generate JUnit XML
        if: always()
        run: |
          # Load test results from previous step
          if [ -f test_results.env ]; then
            source test_results.env
          fi
          
          # Calculate failures (only count actual FAIL, not empty/unknown)
          FAILURES=0
          [ "${test1_result}" = "FAIL" ] && FAILURES=$((FAILURES + 1))
          [ "${test2_result}" = "FAIL" ] && FAILURES=$((FAILURES + 1))
          [ "${test3_result}" = "FAIL" ] && FAILURES=$((FAILURES + 1))
          
          # Create JUnit XML
          cat > junit.xml <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <testsuites name="iOS Simulator Tests" tests="3" failures="$FAILURES" errors="0" time="1.0">
            <testsuite name="crashpad_ios_simulator" tests="3" failures="$FAILURES" errors="0" time="1.0">
              <testcase name="Handler Initialization" classname="ios_simulator_test" time="0.1">
          EOF
          
          if [ "${test1_result}" = "FAIL" ]; then
            echo '      <failure message="Handler initialization failed" type="AssertionError"/>' >> junit.xml
          fi
          echo '    </testcase>' >> junit.xml
          
          echo '    <testcase name="Crash Trigger" classname="ios_simulator_test" time="0.2">' >> junit.xml
          if [ "${test2_result}" = "FAIL" ]; then
            echo '      <failure message="Crash trigger failed" type="AssertionError"/>' >> junit.xml
          fi
          echo '    </testcase>' >> junit.xml
          
          echo '    <testcase name="TAP Mode Tests" classname="ios_simulator_test" time="0.1">' >> junit.xml
          if [ "${test3_result}" = "FAIL" ]; then
            echo '      <failure message="TAP mode tests failed" type="AssertionError"/>' >> junit.xml
          fi
          echo '    </testcase>' >> junit.xml
          
          cat >> junit.xml <<EOF
            </testsuite>
          </testsuites>
          EOF
          
          echo "JUnit XML generated with $FAILURES failures"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-ios
          path: junit.xml
          retention-days: 7

      - name: Test Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: junit.xml
          check_name: iOS Test Results
          comment: true
          update_check: true
          annotate_only: false
          detailed_summary: true
          include_passed: true

      - name: Shutdown Simulator
        if: always()
        run: |
          xcrun simctl shutdown "$SIMULATOR_ID" || true

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ“± iOS Simulator Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "| Test Case | Description | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Parse test results based on job status
          if [ "${{ job.status }}" == "success" ]; then
            echo "| Test 1 | Handler Initialization | âœ… PASS |" >> $GITHUB_STEP_SUMMARY
            echo "| Test 2 | Crash Trigger | âœ… PASS |" >> $GITHUB_STEP_SUMMARY
            echo "| Test 3 | TAP Mode Tests | âœ… PASS |" >> $GITHUB_STEP_SUMMARY
            OVERALL_STATUS="âœ… All tests passed"
          else
            echo "| Test 1 | Handler Initialization | â“ Check logs |" >> $GITHUB_STEP_SUMMARY
            echo "| Test 2 | Crash Trigger | â“ Check logs |" >> $GITHUB_STEP_SUMMARY
            echo "| Test 3 | TAP Mode Tests | â“ Check logs |" >> $GITHUB_STEP_SUMMARY
            OVERALL_STATUS="âŒ Some tests failed"
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Status: $OVERALL_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| crashpad-rs-sys | aarch64-apple-ios | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| crashpad-rs | aarch64-apple-ios | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| crashpad-rs-sys | aarch64-apple-ios-sim | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| crashpad-rs | aarch64-apple-ios-sim | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| ios_simulator_test | aarch64-apple-ios-sim | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Runner OS | ${{ runner.os }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Xcode Version | Latest |" >> $GITHUB_STEP_SUMMARY
          echo "| Simulator Device | iPhone |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Runtime | Available |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- iOS uses in-process handler (different from desktop platforms)" >> $GITHUB_STEP_SUMMARY
          echo "- Crash dumps are processed on next app launch" >> $GITHUB_STEP_SUMMARY
          echo "- TAP mode provides automated test verification" >> $GITHUB_STEP_SUMMARY

